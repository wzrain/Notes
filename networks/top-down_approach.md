# Chapter 1 计算机网络与因特网
## 1.5 协议层次及其服务模型
利用分层体系，可以定义良好的大而复杂系统的某一部分，模块化，每一层易于改变，其余部分保持不变。\
潜在缺点是某一层可能会重复低层的功能，以及某一层可能需要在其他层才出现的信息。
* 应用层 \
包含网络应用程序以及协议，例如HTTP，SMTP（电子邮件），FTP（端系统文件传送）。应用层信息分组被称为报文（messages）。
* 运输层 \
运输层在应用程序端点之间传送应用层报文，有两个协议（TCP和UDP）。TCP提供面向连接的服务，包括保证应用层报文发送以及流量控制。TCP将长报文分成短的报文段（segments），这样网络拥塞时，源端可以减缓传输速率。UDP提供无连接服务，无可靠性，流量控制，拥塞控制。
* 网络层 \
网络层将数据报（datagrams）在主机（host）之间传递。源主机中的传输层协议把传输层报文段以及目的地址传给网络层。网络层将报文段传输给目的主机的传输层。\
IP协议定义了数据报中的字段以及端系统和路由器如何处理这些字段。网络层也包含路由协议，决定数据报如何从源到目的被路由。路由协议有很多种。
* 链路层 \
网络层通过一系列路由器路由数据报，为了将数据报从一个节点（路由器或者主机）运送到另一个节点，网络层依赖数据链路层的服务。在每个节点，网络层将数据报传递给链路层服务，链路层将数据报传送给下一个节点。在下一个节点数据报被传递回网络层。\
某些链路层协议提供可靠传输（节点间可靠传输，与TCP不同（端系统之间））。链路层协议有以太网，WiFi等。数据报传输中可能经过多个链路，不同链路的协议可能不同。链路层包在本书被称为帧（frames）。
* 物理层 \
物理层将链路层帧的每个比特从节点移动到另一个节点。

# Chapter 3 运输层
## 3.2 多路复用与多路分解
将运输层报文段中的数据交付到正确的套接字的工作称为多路分解。从不同套接字接收数据，封装对应的首部信息生成报文段，传递到网络层，这些工作是多路复用。

## 3.3 无连接运输：UDP
UDP除了复用/分解功能以及少量差错检测外没有对IP增加别的东西。UDP从应用进程得到数据，封装源端口和目的端口字段（用于多路复用和分解）以及其他两个小字段，直接交给网络层。由于发送与接收方的运输层实体没有握手，所以是无连接的。\
DNS是通常使用UDP的应用层协议。UDP为DNS查询报文封装首部字段，交给网络层，网络层发送给一个名字服务器。DNS查询进程等待响应，如果没有收到，则试图向另一个名字服务器发送查询或者通知应用程序收不到响应。

UDP对数据的发送时间控制更为精细。TCP的拥塞机制可能会遏制TCP的发送方，不断的重传忽略了可靠交付需要的实际时间。实时应用要求最小的发送速率且不希望延迟，可以容忍数据丢失。\
UDP无需建立连接，不会引入握手的时延。如果DNS运行在TCP上则会很慢。HTTP使用TCP，因为文本数据的web网页要求较高的可靠性。无连接也意味着无需维护连接状态，因此可以支持更多的活跃客户。\
UDP首部仅有8字节开销。TCP为20字节。\
UDP可以通过在应用程序自身建立可靠性机制（例如确认与重传机制）来支持可靠数据传输。

应用层数据占用UDP报文段的数据字段。对于DNS，数据字段包含查询或者响应报文，对于流式音频数据字段包括音频抽样数据。UDP首部包括四个字段，每个两个字节。源端口号和目标端口号用于多路分解，长度字段指示首部加数据的总长度（每个UDP数据包大小不同）。校验和字段用于差错检验，发送方对报文段所有16bit字的和进行反码运算（接收方将校验和与所有16bit字的和加在一起会得到全为1的结果，如果有不为1的位则说明出现了差错）。提供差错检测的原因是链路可靠性无法保证，路由器的内存也可能引入差错，因此需要根据端到端原则提供差错检测。

## 3.5 面向连接的运输：TCP
TCP连接提供的是全双工服务，数据可以双向流动。TCP连接是点对点的，不支持多播。\
发送缓存是三次握手初期设置的缓存，TCP可以从缓存中取出的数据最大为最大报文段长度（保证加上首部的报文能够适合单个链路层帧）。

TCP首部包括源端口号和目的端口号，以及校验和。报文段序号为报文段首字节的字节流编号。确认号为当前累积确认的字节流编号。接收窗口字段用于流量控制，首部长度字段用于指示首部长度（由于选项字段（用于发送接收方协商最大报文段长度或者高速网络环境下用作窗口调节因子）的存在，TCP首部长度可变，如果选项字段为空则首部长度为20字节）。此外还有6bit标志字段（ACK、RST、SYN、FIN等等）。

TCP在定期为某个报文段测量RTT（发送到收到确认的时间），并通过estRTT=(1-a) * estRTT + a * RTT，更新估计的RTT。RTT的偏差devRTT=(1-b) * devRTT + b * |RTT-estRTT|，超时时间为timeout=estRTT+4devRTT。出现超时后timeout将加倍，避免后续确认过早超时，前述的公式仅用于在收到新报文或者新ACK时计算新的超时时间。\
可靠传输可以靠超时重传实现（没有收到ACK时重传相同的报文段）。如果连续发送两个报文段，第一个ACK超时，则重传后重启定时器，只要第二个ACK在新定时器超时前到达即不需要重传第二个。如果第一个ACK超时前另外一个确认号更大的ACK到达（例如有可能是第一个ACK丢失），那么第一个报文也不需要被重传（累积确认）。\
如果某个包丢失，那么接收方由于累积确认可能会重复发送相同的确认号，发送方收到3个冗余ACK则执行快速重传，在超时之前就重传丢失的报文段。

流量控制消除发送方使得接收方缓存溢出的可能性。拥塞控制主要针对网络拥塞。流量控制中发送方维护接收窗口，表示接收方还有多少缓存空间。接收方将自己缓存的空闲空间随着报文的接收窗口字段发送给发送方，发送方通过跟踪最后ACK的字节和最后发送的字节来得到发送但是没有被确认的数据量，并将此数据量控制在接收方窗口大小范围内。\
如果接收方发送了一个声明接收窗口为0的报文，且之后没有任何新的报文要发送给发送方或者报文丢失，那么发送方会因为得不到接收窗口的更新而一直阻塞。TCP规范因此要求接收方窗口为0时，发送方继续发送大小为一字节的报文段，接收方因此会发送确认，并包含新的窗口值。

TCP建立连接时，客户端向服务器端发送特殊报文，SYN=1，随机选择初始序号client_isn，进入SYN_SENT状态。服务器分配缓存和变量，返回SYN=1，确认号client_isn+1，服务器选择初始序号server_isn，进入SYN_RCVD状态。客户端分配缓存和变量，返回SYN=0，确认号server_isn+1，此报文段可以携带数据，服务器接收后双方均进入ESTABLISHED状态。\
客户端关闭连接命令，FIN=1,，进入FIN_WAIT_1状态，接收ACK后进入FIN_WAIT_2状态，服务器进入CLOSN_WAIT状态。之后服务器也会发送FIN=1，进入LAST_ACK状态，客户端收到后返回ACK进入TIME_WAIT状态，等待特定时间后如果ACK丢失则重传，否则CLOSED。

## 3.7 TCP拥塞控制
TCP使得发送方根据所感知的网络拥塞程度限制发送速率。TCP跟踪拥塞窗口的大小，使得最近发送的字节减去最近被确认的字节既小于拥塞窗口也小于接收窗口。如果丢包（超时或者收到3个冗余ACK）则表明可能拥塞。\
TCP连接开始时进行慢启动，拥塞窗口较小（一个最大报文段长度），之后每次翻倍，达到阈值后进入拥塞避免状态，拥塞窗口大小线性增长（如果一个RTT发送n个报文段，则每个ACK会使窗口增加1/n个报文段大小）。出现超时时，重新开始慢启动，设置新的阈值为拥塞时窗口大小的一半。如果收到3个冗余ACK，说明个别报文丢失，不重新慢启动，而是快速重传并且仅将窗口大小减半，进行快速恢复。

# Chapter 4 网络层
## 4.1 概述
转发是指路由器将一个分组从输入链路移动到适当的输出链路。路由选择是指分组从发送方流向接收方时网络层决定分组采取的整体路径。\
每台路由器有一个转发表，通过分组的首部字段（可能是目的地址或者所属连接的指示）在转发表中查询分组被转发的输出链路接口。\
连接建立也是网络层的功能，某些网络层体系结构可以要求从源到目的地沿着路径彼此握手。

## 4.4 网际协议：因特网中的转发和编址
网络层主要有网际协议（IP）、路由选择协议、ICMP协议（用于差错报告和响应某些网络层信息请求）。

### 4.4.1 数据报格式
IPv4数据报中字段包括IP协议版本号、首部长度（因为可能有可变数量的选项）、服务类型（例如实时数据报（电话）和非实时流量（FTP））、数据报长度、标识标志片偏移（用于IP分片，IPv6不允许分片）、、TTL、运输层协议、首部校验和（每台路由器需要重新计算，因为TTL以及选项字段可能改变；IP层只针对首部进行校验，TCP/UDP对整个报文段进行，且TCP/UDP可以不运行在IP上，IP也可以携带非TCP/UDP数据）、源与目的IP地址、选项、数据。

一个链路层帧承载的最大数据量是最大传送单元（MTU），链路层协议的MTU限制IP数据报的长度，且发送与接收方路径上的链路可以使用不同的链路层协议，可能具有不同的MTU。当遇到小MTU时可以对IP数据报进行分片，在到达接收方后进行组装（在路由器中组装会提高复杂性影响路由器性能）。\
发送方将每个数据报的标识号加一。分片后每个片仍然有原数据报的源地址、目的地址和标识号。由于IP是不可靠的服务，最后一个片的标志被记为0，其他片的标志为1，以此来使得接收方确定最后一个片到达。片偏移用于在有片丢失的情况下确定片在原始数据报中的位置。数据报被完全重构之后才会向上传递给运输层，如果有片丢失则数据报会被丢弃（如果上层是TCP则可以让发送方重传）。\
DoS攻击可以通过发送偏移量不为0或者交叠的片使得接收方崩溃。

### 4.4.2 IPv4编址
一台主机通常只有一条链路连接到网络，主机和链路之间有一个接口。一个路由器可能有多个链路与之连接，从而有多个接口。每个接口对应一个全球唯一的IP地址（NAT后的接口除外）。\
IP地址的一部分由子网决定。多个接口可以通过不包含路由器的网络互连（例如主机和路由器接口通过以太网交换机等连接），形成一个子网。子网被分配一个地址，例如223.1.1.0/24，/24为子网掩码，表明最左侧的24位是子网地址，任何连接到该子网的主机都需要有223.1.1.xxx的形式。\
通常同一个组织可以被分配连续的地址，即组织内部的设备共享相同的前缀，这样组织外部的路由器仅考虑前缀比特，减少了路由器中转发表长度（路由器不需要知道对应的地址块还可以被细分为更多的地址）。\
地址剩余的比特区分组织内部设备。IP地址的子网部分可以为8、16或者24比特，分别是A、B、C类网络。主机多的组织子网部分就短。广播地址255.255.255.255会将报文交给同一网络的所有主机。

DHCP协议允许主机自动获取IP地址，网络管理员可以配置DHCP使得主机每次得到相同的地址，或者主机被分配一个临时的IP地址。DHCP可以使得主机得知子网掩码、第一跳路由器地址（默认网关）以及本地DNS服务器地址。在许多用户来来往往仅在有限的时间内需要地址时DHCP是非常理想的方法。每当一台主机加入时DHCP服务器从当前可用的地址池中分配任意一个地址（地址池的大小只需要和最大同时在线的主机个数一致即可，无需等于所有主机的个数）。\
新到达的主机首先进行DHCP发现，客户通过UDP分组发送DHCP发现报文，使用广播地址255.255.255.255以及本主机的源地址（0.0.0.0）。DHCP服务器收到发现报文后返回DHCP提供报文，仍然使用广播地址。客户会在多个DHCP服务器中选择一个。提供报文中包含向客户推荐的IP地址，网络掩码以及IP地址租用期。客户选择一个DHCP服务器，向其发送DHCP请求报文，回显配置参数。DHCP服务器返回ACK，证实参数。

网络地址转换（NAT）支持仅用于专用地域的地址，即地址仅在某网络中的设备有意义。例如一个家庭网络可以使用10.0.0.0/24互相发送分组，但是转发到家庭网络之外的分组不能使用这些地址。\
支持NAT的路由器对外界而言相当于具有单一IP地址的单一设备，所有离开或者进入一个家庭网络的报文都有同一个源/目的IP地址。路由器通过NAT转换表得知分组需要被转发给哪个内部主机。家庭主机向外界发送数据报时路由器为该数据报指派新的端口号，并使用此新的端口号与外界通信。外界返回的数据报的目的端口号同样为此新端口号，路由器通过新端口号检索得到主机的内部地址和端口号。

### 4.4.3 因特网控制报文协议
ICMP被主机和路由器用来彼此沟通网络层信息，最典型的用途是差错报告。如果路由器不能找到一条路径通往Telnet/FTP/HTTP应用指定的主机，路由器就会产生一个目的主机不可达的ICMP报文。ICMP报文是作为IP的有效载荷承载的，与TCP/UDP报文类似。\
ICMP报文有一个类型字段和一个编码字段，并包含导致该ICMP报文生成的IP数据报的首部和前8字节内容（便于发送方确定引发差错的数据报）。\
ping程序发送一个ICMP类型8编码0的报文，表示回显请求，接收方发回一个类型0编码0的回显回答（专用于对ping的回答）。\
Traceroute程序允许跟踪一台主机到世界上任意一台主机之间的路由，使用ICMP报文实现。源主机的Traceroute程序向目的主机发送一系列IP数据报，携带具有不可达UDP端口号的UDP报文段，数据报的TTL依次增长，每个数据报有一个定时器。第n个数据报到达第n个路由器时TTL过期，路由器向源主机发回一个类型11编码0的ICMP报文，包含路由器自己的名字和IP地址。此报文返回源主机时源主机从定时器得到往返时延以及第n台路由器的名字和IP地址。当源主机收到目的主机返回的端口号不可达的ICMP报文时，表明已探测到全部路径。

### 4.4.4 IPv6
IPv6扩大了地址容量到128比特，并引入任播地址，使得数据报可以交付给主机中的任意一个。首部被简化为40字节定长，这样可以被更快地处理。IPv6引入一个流定义，流标签字段用于标识发送方要求进行特殊处理的流，例如使用非默认服务质量或者需要实时服务的流。音视频传输可以被当做一个流，文件传输和电子邮件不是流。高优先级用户承载的流量也可以被当做流。流量类型字段可以用于给出一个流中某些数据报的优先级。\
其他字段有有效载荷长度字段，标识首部后面的字节数量。下一个首部字段标识数据报内容需要交付给哪个上层传输层协议。跳限制字段与TTL类似。源地址与目的地址字段均为128比特。\
IPv6不支持分片，如果数据报大小超过MTU，路由器丢掉该数据报，返回一个分组太大的ICMP报文，发送方需要使用小长度的数据报重发数据。不在路由器中分片加快了网络中IP转发速度。IPv6去掉了首部校验和，依赖传输层或者链路层进行校验，这样无需每次转发都因为TTL变化而重新计算，加快IP转发速度。选项字段同样被取消（可以出现在下一个首部字段上），使得首部为定长。

使用双栈方法的IPv6节点具有完整的IPv4实现，具有发送IPv4和IPv6两种数据报的能力。这种节点必须具有IPv6和IPv4两种地址，并且能够确定另一个节点是否支持IPv6。这个问题可以通过DNS解决，如果节点支持IPv6则DNS返回IPv6地址。如果另一个节点或者本节点只支持IPv4则DNS返回IPv4地址。\
双栈方法中，IPv6的数据字段被复制到IPv4数据报中，进行适当的地址映射，但是一些特定的IPv6字段（例如流标签）会丢失，因此即使之后的节点都是IPv6节点，最终得到的IPv6数据报也不包含初始数据报的所有字段。\
另一种双栈方法是隧道。将两台IPv6路由器之间的IPv4路由器集合称为一个隧道，在隧道发送端将整个IPv6数据报放到一个IPv4数据报的数据中，地址为隧道接收端的IPv6节点，隧道内的IPv4路由器只负责转发该数据报到隧道接收端，接收端解析原始的IPv6数据报继续转发。